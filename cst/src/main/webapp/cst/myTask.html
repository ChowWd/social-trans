<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8"/>
    <title>我的任务</title>

    <meta name="description" content="overview &amp; stats"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="../assets/css/jquery-ui.min.css"/>
    <link rel="stylesheet" href="../assets/css/datepicker.min.css"/>
    <link rel="stylesheet" href="../assets/css/ui.jqgrid.min.css"/>
    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css"/>
    <link href="../assets/css/bootstrap-datetimepicker.min.css" rel="stylesheet"/>

    <!--<link href="../js/common/bootstrap-datetimepicker/bootstrap.css" rel="stylesheet" media="screen">-->
    <link rel="stylesheet" href="../assets/font-awesome/4.2.0/css/font-awesome.min.css"/>
    <!-- page specific plugin styles -->
    <!-- text fonts -->
    <link rel="stylesheet" href="../assets/fonts/fonts.googleapis.com.css"/>

    <!-- ace styles -->
    <link rel="stylesheet" href="../assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="../assets/css/ace-part2.min.css" class="ace-main-stylesheet"/>
    <![endif]-->

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="../assets/css/ace-ie.min.css"/>
    <![endif]-->


    <!-- inline styles related to this page -->

    <!-- ace settings handler -->
    <script src="../assets/js/ace-extra.min.js"></script>

    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

    <!--[if lte IE 8]>
    <script src="../assets/js/html5shiv.min.js"></script>
    <script src="../assets/js/respond.min.js"></script>
    <![endif]-->

    <!--[if !IE]> -->
    <script src="../assets/js/jquery.2.1.1.min.js"></script>

    <!-- <![endif]-->

    <!--[if IE]>
    <script src="../assets/js/jquery.1.11.1.min.js"></script>
    <![endif]-->

    <!--[if !IE]> -->
    <script type="text/javascript">
        window.jQuery
        || document.write("<script src='assets/js/jquery.min.js'>"
                + "<" + "/script>");
    </script>

    <!-- <![endif]-->

    <!--[if IE]>
    <script type="text/javascript">
        window.jQuery || document.write("<script src='assets/js/jquery1x.min.js'>" + "<" + "/script>");
    </script>
    <![endif]-->

    <!--表单验证-->
    <!--<link rel="stylesheet" href="../assets/js/vendor/bootstrap/css/bootstrap.css"/>-->
    <!--<link rel="stylesheet" href="../assets/js/dist/css/bootstrapValidator.css"/>-->

    <script src="../assets/js/bootstrap.min.js"></script>
    <!-- page specific plugin scripts -->
    <script src="../assets/js/bootstrap-datepicker.min.js"></script>
    <script src="../assets/js/jquery.jqGrid.min.js"></script>
    <script src="../assets/js/grid.locale-en.js"></script>
    <script src="../assets/js/bootstrap-datepicker.min.js"></script>



    <!--[if lte IE 8]>
    <script src="../assets/js/excanvas.min.js"></script>
    <![endif]-->

    <!-- ace scripts -->
    <script src="../assets/js/ace-elements.min.js"></script>
    <script src="../assets/js/ace.min.js"></script>
    <script src="../js/common/bootstrp-tab.js"></script>
    <script type="text/javascript" src="../js/commonJs/common.js"></script>
    <script type="text/javascript" src="../js/commonJs/appCommon.js"></script>
    <script type="text/javascript" src="../js/commonJs/commonUtils.js"></script>
    <!--时间控件-->
    <!--<script type="text/javascript" src="../js/locales/bootstrap-datetimepicker.fr.js"></script>-->
    <script type="text/javascript" src="../js/commonJs/ajaxfileupload.js" ></script>
</head>
<body class="no-skip">
<div class="page-content">
    <div class="page-header">
        <h1>
            我的任务
            <small><i class="ace-icon fa fa-angle-double-right"></i>
            </small>
        </h1>
    </div>


    <!-- /.page-header -->
    <div class="row">
        <div class="col-xs-12">
            <!--工具栏 -->
            <!--<div class="tool_bg">-->
                <!--<button class="btn btn-yellow" data-toggle="modal" onclick="openTask()">-->
                    <!--<i class="ace-icon fa fa-plus-circle"></i> 我的任务-->
                <!--</button>-->
            <!--</div>-->
            </br>
            <div style="padding-top: 5px">
                <table class="table" id="task_table">
                </table>
                <div id="common_task_pager"></div>
            </div>

            <div style="padding-top: 60px">
                <table class="table" id="task_comment_table">
                </table>
                <div id="common_task_comment_pager"></div>
            </div>
        </div>
    </div>

    <div tabindex="-1" class="modal fade in bs-example-modal-lg" id="update-modal" aria-hidden="false" style="padding-right: 17px; display:none">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                    <h3 class="smaller lighter blue no-margin">翻译窗口</h3>
                </div>
                <input type="hidden" name="commentId">
                <input type="hidden" name="fileId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12">

                            <form class="form-horizontal" style="margin: 0px" >
                                <table style="width: 100%;margin-left: 4% ;border-collapse:separate; border-spacing:10px;" cellpadding="10" cellspacing="10" >
                                    <tr>
                                        <td align="right">
                                            <label class="control-label" for="comment">翻译内容:</label>
                                        </td>

                                        <td>
                                            <textarea id="comment" name="comment" rows="5" cols="100" readonly></textarea>
                                        </td>
                                    </tr>
                                    <tr style="margin-top: 10px">
                                        <td align="right">
                                            <label class="control-label" for="commentResult">翻译结果:</label>
                                        </td>
                                        <td>
                                            <textarea id="commentResult" name="commentResult" rows="5" cols="100" ></textarea>
                                        </td>
                                    </tr>
                                </table>

                            </form>


                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-lg btn-danger pull-left" onclick="closeTranslateWin()">
                        <i class="ace-icon fa  fa-undo"></i> 取消
                    </button>
                    <button class="btn btn-lg btn-success" type="button" onclick="upTranslateFn()">
                        <i class="ace-icon fa fa-check"></i> 提交
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>






<script>


    var verify_result = false;


    /*页面初始化调用*/
    $(document).ready(function () {
        doSearch();
        //初始化时间控件
//        initDateTimeModule();
    });

    function initDateTimeModule() {
        $('.datetime').datepicker({
            autoclose: true,
            todayHighlight: true,
            format: 'yyyy-mm-dd'
        })

        $('.datetime').each(function () {
            $(this).next().on(ace.click_event, function () {
                $(this).prev().focus();
            });
        })
    }



    /*查询当前用户的所有任务*/
    function doSearch() {
        var selectAllUrl_ = "/" + PROJECT_NAME + "/TaskAction/selectTaskByUerId.do";
        var userId = getCookieValue("userId");
        var params = {
            userId:userId
        };
        $("#task_table").GridUnload();
        $("#task_table")
                .jqGrid(
                        {
                            url: selectAllUrl_,
                            postData: params,
                            datatype: "json",
                            height: 200,
                            mtype: "post",
                            jsonReader: {
                                "root": "data.rows",
                                "page": "data.page",
                                "total": "data.total",
                                "records": "data.records",
                                "repeatitems": true
                            },
                            colModel: [
                                {
                                    "name": "id",
                                    "label": "id",
                                    "hidden": true
                                },
                                {
                                    "name": "taskId",
                                    "label": "任务id",
                                    "hidden": true
                                },
                                {
                                    "name": "submitterId",
                                    "label": "领取者id",
                                    "hidden": true
                                },
                                {
                                    "name": "fileId",
                                    "label": "任务id",
                                    "hidden": true
                                },
                                {
                                    "name": "filePath",
                                    "label": "文件路径",
                                    "hidden": true
                                },
                                {
                                    "name": "comment",
                                    "label": "任务内容",
                                },
                                {
                                    "name": "submitter",
                                    "label": "任务提交者",
                                }
                                ],
                            viewrecords: true,
                            rowNum: 10,
                            rowList: [10, 20, 30],
                            pager: "#common_task_pager",
                            beforeSelectRow: function (rowid, e) {
                                jQuery("#task_table").jqGrid('resetSelection');

                                var rowData = $("#task_table").jqGrid('getRowData',rowid);
//                                console.log(rowData);
                                showTranslationString(rowData);
                                return (true);
                            },
                            altRows: true,
                            multiselect: false,
                            multiboxonly: false,
                            rownumbers: true,
                            autowidth: true,
                            loadComplete: function () {
                                var table = this;
                                setTimeout(function () {
                                    updatePagerIcons(table);
                                }, 0);
                            }
                        });
    }



    function showTranslationString(rowData) {
        var selectAllUrl_ = "/" + PROJECT_NAME + "/TaskAction/selectTranslateComment.do";

        var params = {
            filePath:rowData.filePath,
            fileId:rowData.fileId
        };

        ajaxFunction(
                selectAllUrl_,
                params,
                function (result) {
                    if (result.success) {
                        $("#task_comment_table").GridUnload();
                        $("#task_comment_table").jqGrid(
                                {
                                    data: result.data,
                                    datatype: "local",
                                    height: 250,
                                    colModel: [
                                        {
                                            "name": "commentId",
                                            "label": "commentId",
                                            "hidden": true
                                        },
                                        {
                                            "name": "fileId",
                                            "label": "附件id",
                                            "hidden": true
                                        },
                                        {
                                            "name": "comment",
                                            "label": "翻译内容",
                                            "formatter":function (value,options,rowData) {
                                                //只显示0-40个字符
                                                var str = value.substring(0,40);
//                                                console.log(str);
                                                return str;

                                            }
                                        },
                                        {
                                            "name": "fnDiv",
                                            "label": "功能",
                                            "formatter": function (value, options,
                                                                   rowData) {
                                                return "<div style='margin-left: 8px;'>"
                                                        + "<div  class='ui-pg-div ui-inline-edit'  style='float: left; cursor: pointer;'  onclick='openTranslateWin("
                                                        + JSON
                                                                .stringify(rowData)
                                                        + ")'; ><span class='ui-icon ui-icon-pencil'></span></div>"
//                                                        + "<div  class='ui-pg-div ui-inline-del' style='margin-left: 5px; float: left;'  onclick=\"delConfirm('"
//                                                        + rowData.id
//                                                        + "')\" data-original-title='Delete'><span class='ui-icon ui-icon-trash'></span></div></div>"
                                                        ;
                                                ;

                                            }
                                        }
                                        ],
                                    viewrecords: true,
                                    rowNum: 5,
                                    rowList: [5, 10, 15],
                                    pager: "#common_task_comment_pager",
                                    altRows: true,
                                    multiselect: false,
                                    multiboxonly: true,
                                    rownumbers: true,
                                    autowidth: true,
                                    loadComplete: function () {
                                        var table = this;
                                        setTimeout(function () {
                                            // styleCheckbox(table);
                                            // updateActionIcons(table);
                                            updatePagerIcons(table);
                                            // enableTooltips(table);
                                        }, 0);
                                    }
                                });
                    }

                });
    }



    /*翻译窗口*/
    function openTranslateWin(rowData) {
        var selectURL_ = "/" + PROJECT_NAME + "/TaskAction/selectTranslateResult.do";
        var params = {
            fileId:rowData.fileId,
            commentId:rowData.commentId
        }
        ajaxFunction(selectURL_,params,function (result) {
            if(result.success){
                $("#update-modal").modal('show');

                console.log(result);

                /*翻译界面数据初始化*/
                update_init($('#update-modal'), result.data[0]);
            }else {
                bootbox.alert("加载失败");
            }

        })

    }

    /*关闭翻译界面*/
    function closeTranslateWin() {
        $("#update-modal").modal('hide');
    }

    /*保存当前翻译内容，按条*/
    function upTranslateFn() {
        var params = formToJsonstr('update-modal');
//        console.log(params);
        var updateFnUrl_ = "/" + PROJECT_NAME + "/TaskAction/updateTranslateResult.do";
        ajaxFunction(updateFnUrl_,params,function (result) {
            if(result.success){
                bootbox.alert("修改成功");
                closeTranslateWin();
            }else{
                bootbox.alert("修改失败");
            }
        });

    }


    /*信息重置*/
    function reset_add($dom) {
        //textarea select
        $dom.find(":input").each(function () {
            var $this = $(this);
            var name = $this.attr("name");
            $this.val("");
        });
    }










    function delConfirm() {
        bootbox.alert("无法删除");
    }

    /*进入我的任务*/
    function openTask() {
        var obj = new Object();
        //注意命名规则，以页面名+该按钮功能名为id
        obj.id="我的任务";
        //id与addtabs一致
        obj.addtabs="我的任务";
        //title自己命名
        obj.title = "我的任务";
        //url
        obj.url="cst/myTask.html";
        //是否可以关闭
        obj.close=true;
        //调用父iframe的方法
        window.parent.addTabs(obj);
    }

    //    $('#add_finishedTime').datetimepicker({
    //        language: 'zh-CN',
    //        autoclose: 1,
    //        format: 'yyyy:MM:dd',
    //        weekStart: 5,
    //        startDate: '2014:12:15',
    //        endDate: '2014:12:28',
    //        startView: 1,
    //        minView: 2,
    //        todayBtn: 1,
    //        todayHighlight: 1,
    //        keyboardNavigation: 1,
    //        minuteStep: 6,
    //        showMeridian: 1,
    //    });

    var GetLength = function (str) {
        ///<summary>获得字符串实际长度，中文2，英文1</summary>
        ///<param name="str">要获得长度的字符串</param>
        var realLength = 0, len = str.length, charCode = -1;
        for (var i = 0; i < len; i++) {
            charCode = str.charCodeAt(i);
            if (charCode >= 0 && charCode <= 128) realLength += 1;
            else realLength += 2;
        }
        return realLength;
    };

    //js截取字符串，中英文都能用
    //如果给定的字符串大于指定长度，截取指定长度返回，否者返回源字符串。
    //字符串，长度



</script>

</body>


</html>
