<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8"/>
    <title>权限管理界面</title>

    <meta name="description" content="overview &amp; stats"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="../assets/css/jquery-ui.min.css"/>
    <link rel="stylesheet" href="../assets/css/datepicker.min.css"/>
    <link rel="stylesheet" href="../assets/css/ui.jqgrid.min.css"/>
    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../assets/font-awesome/4.2.0/css/font-awesome.min.css"/>
    <!-- page specific plugin styles -->
    <!-- text fonts -->
    <link rel="stylesheet" href="../assets/fonts/fonts.googleapis.com.css"/>

    <!-- ace styles -->
    <link rel="stylesheet" href="../assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style"/>

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="../assets/css/ace-part2.min.css" class="ace-main-stylesheet"/>
    <![endif]-->

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="../assets/css/ace-ie.min.css"/>
    <![endif]-->

    <!-- inline styles related to this page -->
    <!--zTrees-->
    <link rel="stylesheet" href="../assets/zTree_v3/css/demo.css" type="text/css">
    <link rel="stylesheet" href="../assets/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">

</head>
<body class="no-skip">

<div class="page-content">
    <div class="page-header">
        <h1>
            权限信息
            <small><i class="ace-icon fa fa-angle-double-right"></i>
            </small>
        </h1>
    </div>


    <!-- /.page-header -->
    <div class="row">
        <div class="col-xs-12">
            <!--工具栏 -->
            <div class="tool_bg">
                <button class="btn btn-yellow" data-toggle="modal"  onclick="openAddWin()">
                    <i class="ace-icon fa fa-plus-circle"></i> 添加
                </button>

            </div>
            <!--</br>-->
            <div style="padding-top: 5px">
                <table class="table" id="permission_table">
                </table>
                <div id="common_permission_pager"></div>
            </div>
        </div>
    </div>

    <!--新增权限界面-->
    <div tabindex="-1" class="modal fade in" id="add-modal" aria-hidden="false"
         style="padding-right: 17px; display:none">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button>
                    <h3 class="smaller lighter blue no-margin">新增窗口</h3>
                </div>

                <div class="modal-body" style="height: 350px">
                    <div class="row">
                        <div class="col-xs-12">

                            <!--</form>-->
                            <form class="form-horizontal">
                                <div style="margin-left: 100px">
                                    <div class="form-group">
                                        <label for="add_permissionName" class="col-sm-3 control-label">权限名称</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control" id="add_permissionName" name="permissionName"
                                                   placeholder="请输入权限名称">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="add_description" class="col-sm-3 control-label">权限说明</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control" id="add_description"
                                                   name="description" placeholder="请输入权限说明">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="add_menuName" class="col-sm-3 control-label">菜单</label>
                                        <div id="add_menuName" class="col-sm-6">

                                        </div>
                                    </div>
                                    <div>
                                        <!--<div class="content_wrap">-->
                                            <!--<div class="zTreeDemoBackground left">-->
                                                <!--<ul class="list">-->
                                                    <!--<li class="title">&nbsp;&nbsp;Test: <input id="citySel" type="text" readonly value="" style="width:120px;" onclick="showMenu();" />-->
                                                        <!--&nbsp;<a id="menuBtn" href="#" onclick="showMenu(); return false;">select</a></li>-->
                                                <!--</ul>-->
                                            <!--</div>-->

                                        <!--</div>-->
                                        <div id="menuContent" class="menuContent" style="display:none; position: absolute;">
                                            <ul id="treeDemo" class="ztree" style="margin-top:0; width:222px; height: 200px;" ></ul>
                                        </div>
                                    </div>
                                </div>

                            </form>

                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-lg btn-danger pull-left" onclick="closeAddWin()">
                        <i class="ace-icon fa  fa-undo"></i> 取消
                    </button>
                    <button class="btn btn-lg btn-success" type="button" onclick="addFn()">
                        <i class="ace-icon fa fa-check"></i> 提交
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>


<!--JS-->

<!-- ace settings handler -->
<script src="../assets/js/ace-extra.min.js"></script>

<!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

<!--[if lte IE 8]>
<script src="../assets/js/html5shiv.min.js"></script>
<script src="../assets/js/respond.min.js"></script>
<![endif]-->

<!--[if !IE]> -->
<script src="../assets/js/jquery.2.1.1.min.js"></script>

<!-- <![endif]-->

<!--[if IE]>
<script src="../assets/js/jquery.1.11.1.min.js"></script>
<![endif]-->

<!--[if !IE]> -->
<script type="text/javascript">
    window.jQuery
    || document.write("<script src='assets/js/jquery.min.js'>"
            + "<" + "/script>");
</script>

<!-- <![endif]-->

<!--[if IE]>
<script type="text/javascript">
    window.jQuery || document.write("<script src='assets/js/jquery1x.min.js'>" + "<" + "/script>");
</script>
<![endif]-->

<!--表单验证-->
<!--<link rel="stylesheet" href="../assets/js/vendor/bootstrap/css/bootstrap.css"/>-->
<!--<link rel="stylesheet" href="../assets/js/dist/css/bootstrapValidator.css"/>-->

<script src="../assets/js/bootstrap.min.js"></script>
<!-- page specific plugin scripts -->
<script src="../assets/js/bootstrap-datepicker.min.js"></script>
<script src="../assets/js/jquery.jqGrid.min.js"></script>
<script src="../assets/js/grid.locale-en.js"></script>


<script src="../assets/js/bootstrap-datepicker.min.js"></script>
<script src="../assets/js/bootbox.min.js"></script>


<!--[if lte IE 8]>
<script src="../assets/js/excanvas.min.js"></script>
<![endif]-->

<!-- ace scripts -->
<script src="../assets/js/ace-elements.min.js"></script>
<script src="../assets/js/ace.min.js"></script>
<script src="../js/common/bootstrp-tab.js"></script>
<script type="text/javascript" src="../js/commonJs/common.js"></script>
<script type="text/javascript" src="../js/commonJs/appCommon.js"></script>
<script type="text/javascript" src="../js/commonJs/commonUtils.js"></script>

<!--表单验证-->
<script type="text/javascript" src="../assets/js/dist/js/bootstrapValidator.js"></script>
<!--zTree-->
<script type="text/javascript" src="../assets/zTree_v3/js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="../assets/zTree_v3/js/jquery.ztree.excheck.js"></script>
<script>


    $(document).ready(function () {

        //查询角色
        doSearch();
    });

    /*权限添加*/
    function addFn(){
        //获取被选择的checkbox的id
        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),//根据ztreeId来获取ztree对象
                nodes = zTree.getCheckedNodes(true),//获取输入框被勾选 或 未勾选的节点集合
                ids = [];
        for (var i=0, l=nodes.length; i<l; i++) {
            ids.push(nodes[i].id);
        }
//        console.log(ids);
        var params = formToJsonstr('add-modal');
        var queryParams = {
            params:JSON.stringify(params),
            menuIds:JSON.stringify(ids)
        }
        var addURL_ = "/" + PROJECT_NAME + "/Permission/addPermissionAndMenu.do";
        ajaxFunction(addURL_,queryParams,function (result) {
            if(result.success){
                closeAddWin();
                doSearch();
            }else {
                bootbox.alert("插入失败");
                closeAddWin();
            }
        });
    }

    /*打开添加界面*/
    function openAddWin() {
        $("#add-modal").modal('show');
        selectAllMenu();
        showMenu();
    }

    /*关闭新增角色界面*/
    function closeAddWin() {
        $("#add-modal").modal('hide');
        //数据清空
        reset_data($('#add-modal'));
    }

    function reset_data($dom) {
        //textarea select
        $dom.find(":input").each(function () {
            var $this = $(this);
            var name = $this.attr("name");
            $this.val("");
        });
    }

    /*查询菜单*/
    function selectAllMenu() {
        //加载zTree
        $.fn.zTree.init($("#treeDemo"), setting);
    }

    /*查询所有权限*/
    function doSearch() {
        var selectAllUrl_ = "/" + PROJECT_NAME + "/Permission/selectAllPermission.do";

        ajaxFunction(
                selectAllUrl_,
                null,
                function (result) {
                    if (result.success) {
                        $("#permission_table").GridUnload();
                        $("#permission_table").jqGrid(
                                {
                                    data: result.data,
                                    datatype: "local",
                                    height: 250,
                                    colModel: [
                                        {
                                            "name": "permissionId",
                                            "label": "permissionId",
                                            "hidden": true
                                        },
                                        {
                                            "name": "permissionName",
                                            "label": "权限名称"
                                        },
                                        {
                                            "name": "description",
                                            "label": "权限说明",
                                        },
                                        {
                                            "name": "fnDiv",
                                            "label": "功能",
                                            "formatter": function (value, options,
                                                                   rowData) {
                                                return "<div style='margin-left: 8px;'>"
                                                        + "<div  class='ui-pg-div ui-inline-edit'  style='margin-left: 5px; float: left;'  onclick='openUpdateWin("
                                                        + JSON.stringify(rowData)
                                                        + ")'; ><span class='ui-icon ui-icon-pencil'></span></div>"
                                                        + "<div  class='ui-pg-div ui-inline-del' style='margin-left: 5px; float: left;'  onclick=\"delConfirm('"
                                                        + rowData.roleId
                                                        + "')\" data-original-title='Delete'><span class='ui-icon ui-icon-trash'></span></div></div>";

                                            }
                                        }
                                    ],
                                    viewrecords: true,
                                    rowNum: 10,
                                    rowList: [10, 20, 30],
                                    pager: "#common_permission_pager",
                                    altRows: true,
                                    multiselect: false,
                                    multiboxonly: true,
                                    rownumbers: true,
                                    autowidth: true,
                                    loadComplete: function () {
                                        var table = this;
                                        setTimeout(function () {
                                            // styleCheckbox(table);
                                            // updateActionIcons(table);
                                            updatePagerIcons(table);
                                            // enableTooltips(table);
                                        }, 0);
                                    }
                                });
                    }

                });
    }


    var setting = {
        check: {
            enable: true,
            //父节点子节点关联
            chkboxType: {"Y":"ps", "N":"ps"}
        },
        view: {
            dblClickExpand: false,
            showLine: false
        },
        async: {
            enable: true,
            url:"/"+PROJECT_NAME+"/Menu/getMenuList.do"
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            beforeClick: beforeClick,
            onCheck: onCheck,
            onAsyncSuccess:zTreeOnAsyncSuccess
        }
    };

    function zTreeOnAsyncSuccess(event, treeId, treeNode, msg) {
//			console.log(treeNode);
        zTree_Menu = $.fn.zTree.getZTreeObj("treeDemo");
//        console.log(zTree_Menu.getNodes()[0].data);
        var zNodes = zTree_Menu.getNodes()[0].data
        $.fn.zTree.init($("#treeDemo"), setting, zNodes);

    };

    function beforeClick(treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo");
        zTree.checkNode(treeNode, !treeNode.checked, null, true);
        return false;
    }

    /*点选checkbox触发*/
    function onCheck(e, treeId, treeNode) {
        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),//根据ztreeId来获取ztree对象
                nodes = zTree.getCheckedNodes(true),//获取输入框被勾选 或 未勾选的节点集合
                ids = [];
        for (var i=0, l=nodes.length; i<l; i++) {
            ids.push(nodes[i].id);
        }
//        console.log(ids);
        return ids;
    }

    function showMenu() {
        var cityOffset = $("#add_description").offset();
        $("#menuContent").css({left:"235px", top:"100px"}).slideDown("normal");
//        $("#menuContent").css({left:cityOffset.right *10+ "px", top:"100px"}).slideDown("normal");

        $("body").bind("mousedown");
    }
//    function hideMenu() {
//        $("#menuContent").fadeOut("fast");
//        $("body").unbind("mousedown", onBodyDown);
//    }
//    function onBodyDown(event) {
//        if (!(event.target.id == "menuBtn" || event.target.id == "citySel" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {
//            hideMenu();
//        }
//    }

</script>
</body>

</html>
